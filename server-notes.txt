!#/bin/bash

#extracted from file openstack-mgmt-remote-access.txt 
export CLIENT_SSH_TUNNEL_PORT="8000"
export CLIENT_SSH_PORT_FORWARD="8001"
export CLIENT_UI_PORT_FORWARD="9001"
export CLIENT_FQDN="86.146.112.89"

#########setup auto ssh to reverse ssh as a service#######
sudo apt install -y autossh
cat << EOF | sudo tee /etc/ssh/ssh_config.d/auto-ssh-systemd-hosts.conf
Host $CLIENT_FQDN 
    HostName vm-in-deepfield-gcp
    IdentityFile /home/support/.ssh/id_rsa
    User support
    Port $CLIENT_SSH_TUNNEL_PORT 
    RemoteForward $CLIENT_SSH_PORT_FORWARD 127.0.0.1:22
    RemoteForward $CLIENT_UI_PORT_FORWARD 127.0.0.1:443
    GatewayPorts yes
    Compression yes
EOF

echo "note: to test autossh"
echo "ssh support@vm-in-deepfield-gcp -p 8000"
echo "autossh vm-in-deepfield-gcp"

#create the reverse-ssh systemctl  service
cat << EOF | sudo tee /etc/systemd/system/reverse-ssh.service
[Unit]
Description=Keeps an SSH tunnel to 'vm-in-deepfield-gcp' open
After=network-online.target
[Service]
User=support
ExecStart=/usr/bin/autossh -M 0 -N -q -o "ServerAliveInterval 60" -o "ServerAliveCountMax 3" vm-in-deepfield-gcp
ExecStop=/usr/bin/killall -s KILL autossh
Restart=always
RestartSec=3
[Install]
WantedBy=multi-user.target
EOF

#setup the service but don't run it yet
sudo systemctl daemon-reload
sudo systemctl enable reverse-ssh.service
sudo systemctl stop reverse-ssh.service
sudo systemctl status reverse-ssh.service

echo "service has been installed:"
echo "sudo systemctl start reverse-ssh.service"
echo "sudo systemctl stop reverse-ssh.service"
echo "sudo systemctl status reverse-ssh.service"



